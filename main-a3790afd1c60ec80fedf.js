(()=>{"use strict";var e,t;!function(e){e.incrementLevel="increment-level",e.wordCheck="word-check",e.restoreGame="restore-game"}(e||(e={})),function(e){e.showRestoreModal="showRestoreModal"}(t||(t={}));const s=(e,t)=>e.length-t.length,n=(e,t)=>{const s=(e=>e.split("").reduce(((e,t)=>{const s=e.get(t)||0;return e.set(t,s+1),e}),new Map))(t);return s.forEach(((t,s)=>{const n=e.get(s)||0;return e.set(s,Math.max(n,t)),e})),e},r="640px",o=`\n    <style>\n        * {\n          box-sizing: border-box;\n        }\n\n        @keyframes fadeIn {\n          to {\n            opacity: 1;\n          }\n        }    \n    </style>\n    <main part="app-wrapper" style="max-width: ${r}">\n        <title-component level=""></title-component>\n        <div class="word-list" part="word-list"></div>\n        <controller-component letters=""></controller-component>\n    </main>\n    `,i="app-words-level",l="app-words-words";var d=function(e,t,s,n){return new(s||(s=Promise))((function(r,o){function i(e){try{d(n.next(e))}catch(e){o(e)}}function l(e){try{d(n.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(i,l)}d((n=n.apply(e,t||[])).next())}))};class a extends HTMLElement{constructor(){super(),this.incrementLevel=()=>{this.level+=1,this.setupLevel(),localStorage.setItem(i,String(this.level)),localStorage.removeItem(l)},this.checkWord=e=>{const t=e.detail;this.wordSet.includes(t)&&(this.visibleWords.add(t),this.renderWords(),localStorage.setItem(l,Array.from(this.visibleWords).join())),this.wordSet.length===this.visibleWords.size&&this.shadowRoot&&(this.visibleWords.clear(),this.shadowRoot.innerHTML=`<win-screen-component level="${this.level}"></win-screen-component>`)},this.onBroadcastChannelMessage=e=>{var s;if(e.data.event===t.showRestoreModal){const e=document.createElement("restore-modal-component");null===(s=this.shadowRoot)||void 0===s||s.appendChild(e)}},this.handleBroadcastRestore=()=>{this.restoreGame(),this.broadcastChannel.postMessage({event:t.showRestoreModal})},this.level=1,this.wordSet=[],this.visibleWords=new Set,this.broadcastChannel=new BroadcastChannel("main"),this.attachShadow({mode:"open"}),this.restoreGame()}restoreData(){const e=localStorage.getItem(i),t=localStorage.getItem(l);e&&(this.level=Number(e)),t&&(this.visibleWords=new Set(t.split(",")))}restoreGame(){this.restoreData(),this.setupLevel()}updateWordSet(){return d(this,void 0,void 0,(function*(){const e=this.level%3||3;try{const t=yield fetch(`/levels/${e}.json`);if(!t.ok)throw Error();const{words:n}=yield t.json();this.wordSet=n.sort(s)}catch(e){alert("Упс... Мы скоро все исправим. Попробуйте снова через несколько минут!"),console.error(e)}}))}setupLevel(){return d(this,void 0,void 0,(function*(){if(yield this.updateWordSet(),this.shadowRoot){this.shadowRoot.innerHTML=o;const t=this.shadowRoot.querySelector("title-component"),s=this.shadowRoot.querySelector("controller-component");null==t||t.setAttribute("level",this.level.toString()),null==s||s.setAttribute("letters",(e=this.wordSet,[...e.reduce(n,new Map).entries()].reduce(((e,[t,s])=>[...e,...new Array(s).fill(t)]),[])).join("")),this.renderWords()}var e}))}connectedCallback(){var s,n,r;null===(s=this.shadowRoot)||void 0===s||s.addEventListener(e.incrementLevel,this.incrementLevel),null===(n=this.shadowRoot)||void 0===n||n.addEventListener(e.wordCheck,this.checkWord),null===(r=this.shadowRoot)||void 0===r||r.addEventListener(e.restoreGame,this.handleBroadcastRestore),this.broadcastChannel.postMessage({event:t.showRestoreModal}),this.broadcastChannel.onmessage=this.onBroadcastChannelMessage}renderWords(){const e=this.shadowRoot&&this.shadowRoot.querySelector(".word-list");if(!this.shadowRoot||!e)return;const t=this.wordSet[this.wordSet.length-1].length;e.innerHTML="",this.wordSet.forEach((s=>{const n=document.createElement("word-component"),r=this.visibleWords.has(s)?s:s.replace(/./g," ");n.setAttribute("data",r),n.setAttribute("max-size",t.toString()),e.appendChild(n)}))}}customElements.define("app-component",a);class c extends HTMLElement{constructor(){super(),this.setPointerDown=()=>{this.pointerdown=!0},this.setPointerUp=()=>{var e;this.pointerdown=!1,this.dispatchWordCheck(),this.selected.forEach((e=>e.part.remove("selected"))),this.selected=[],null===(e=this.selectedLetters)||void 0===e||e.setAttribute("letters","")},this.onPointerIn=({target:e})=>{var t,s;const n=e;this.pointerdown&&(this.selected[this.selected.length-2]===n?null===(t=this.selected.pop())||void 0===t||t.part.remove("selected"):this.selected.includes(n)||(this.selected.push(n),n.part.add("selected")),null===(s=this.selectedLetters)||void 0===s||s.setAttribute("letters",this.selectedWord))},this.onPointerDown=({target:e})=>{var t;const s=e;this.selected.push(s),s.part.add("selected"),null===(t=this.selectedLetters)||void 0===t||t.setAttribute("letters",this.selectedWord)},this.letters=[],this.selected=[],this.pointerdown=!1,this.controllerNode=null,this.selectedLetters=null}static get observedAttributes(){return["letters"]}get selectedWord(){return this.selected.map((e=>e.innerText.toLowerCase())).join("")}dispatchWordCheck(){const t=new CustomEvent(e.wordCheck,{detail:this.selectedWord,bubbles:!0});this.dispatchEvent(t)}connectedCallback(){this.innerHTML='\n        <div part="controller-wrapper">\n            <selected-letters-component letters=""></selected-letters-component>\n            <div style="width: 300px" class="controller-letters" part="controller-letters"></div>   \n        </div>',this.controllerNode=this.querySelector(".controller-letters"),this.selectedLetters=this.querySelector("selected-letters-component"),document.addEventListener("pointerdown",this.setPointerDown),document.addEventListener("pointerup",this.setPointerUp)}attributeChangedCallback(e,t,s){var n;"letters"===e&&t!==s&&(this.letters=(n=s.split("")).reduce(((e,t,s)=>{const r=(o=n.length-1,Math.floor(Math.random()*(o+1-0)+0));var o;return[e[s],e[r]]=[e[r],e[s]],e}),[...n])),this.render()}render(){this.controllerNode&&(this.controllerNode.innerHTML="",this.letters.forEach(((e,t,s)=>{var n;const r=document.createElement("div"),{x:o,y:i}=((e,t)=>{const s=2*t*Math.PI-Math.PI/2;return{x:150*Math.cos(s),y:150*Math.sin(s)}})(0,t/s.length);r.addEventListener("pointerdown",this.onPointerDown),r.addEventListener("pointerenter",this.onPointerIn),r.innerHTML=e,r.setAttribute("part","controller-letter"),null===(n=this.controllerNode)||void 0===n||n.appendChild(r),setTimeout((()=>{r.style.transform=`translate(${o}px, ${i}px)`}),100)})))}}customElements.define("controller-component",c);class h extends HTMLElement{constructor(){super(),this.button=null}dispatchBroadcastEvent(){const t=new CustomEvent(e.restoreGame,{bubbles:!0});this.dispatchEvent(t)}connectedCallback(){var e;this.innerHTML='\n      <svg> \n        <clipPath id="mask" clipPathUnits="objectBoundingBox">\n            <path d="M1,0 l-1,0,0,0.482 c0,0.122,0.027,0.227,0.065,0.251 l0.407,0.259 c0.017,0.011,0.034,0.011,0.05,0 l0.414,-0.26 c0.037,-0.023,0.065,-0.128,0.065,-0.251 l0,-0.481,0,0"/>\n        </clipPath>  \n      </svg>\n      <div part="restore-modal">\n        <div part="restore-modal-wrapper">\n            <div part="restore-modal-title-wrapper">\n                <div part="restore-modal-title-shadow">\n                    <h1 part="restore-modal-title">Две вкладки <br /> с игрой?</h1>\n                </div>\n            </div>\n            <p part="restore-modal-text">Похоже, игра открыта в нескольких вкладках браузера.\n            Чтобы продолжить играть в <br /> этой вкладке, обновите <br /> страницу.</p>\n            <button type="button" part="restore-modal-button">Обновить</button>\n        </div>\n      </div>\n    ',this.button=this.querySelector("button"),null===(e=this.button)||void 0===e||e.addEventListener("pointerdown",this.dispatchBroadcastEvent)}}customElements.define("restore-modal-component",h);class p extends HTMLElement{constructor(){super()}static get observedAttributes(){return["letters"]}get letters(){return(this.getAttribute("letters")||"").split("")}attributeChangedCallback(){this.render()}render(){const e=document.createElement("div");e.setAttribute("part","controller-selected-wrapper"),this.letters.forEach((t=>{const s=document.createElement("div"),n=`min(100vw, 100vh, ${r})/${this.letters.length} - 6px`;s.setAttribute("part","controller-selected-letter"),s.style.width=`calc(${n})`,s.style.margin="3px",s.innerHTML=t,e.appendChild(s)})),this.innerHTML="",this.appendChild(e)}}customElements.define("selected-letters-component",p);class u extends HTMLElement{constructor(){super()}static get observedAttributes(){return["level"]}get level(){return this.getAttribute("level")||""}connectedCallback(){this.render()}attributeChangedCallback(e,t,s){"level"===e&&t!==s&&this.render()}render(){this.innerHTML=`<h1 part="main-title">Уровень ${this.level}</h1>`}}customElements.define("title-component",u);class m extends HTMLElement{constructor(){super()}handleClick(){const t=new CustomEvent(e.incrementLevel,{bubbles:!0});this.dispatchEvent(t)}connectedCallback(){this.render(),this.addEventListener("pointerdown",this.handleClick)}render(){this.innerHTML=` \n      <main part="win-screen-wrapper" style="max-width: ${r}">\n          <div>\n            <h1 part="win-screen-title">Уровень ${this.getAttribute("level")} пройден</h1>\n            <p part="win-screen-subtitle">Изумительно!</p>\n          </div>\n          <button part="win-screen-button">Уровень ${Number(this.getAttribute("level"))+1}</button>\n      </main>\n    `}}customElements.define("win-screen-component",m);class v extends HTMLElement{constructor(){super()}static get observedAttributes(){return["data","max-size"]}get letters(){var e;return(null===(e=this.getAttribute("data"))||void 0===e?void 0:e.split(""))||[]}get maxSize(){return Number(this.getAttribute("max-size"))}attributeChangedCallback(){this.render()}render(){const e=document.createElement("div");e.setAttribute("part","word-cell-wrapper"),e.classList.add("letter-list"),this.letters.forEach((t=>{const s=document.createElement("div"),n=`min(100vw, 100vh, ${r})/${this.maxSize} - 6px`;s.classList.add("cell"),s.setAttribute("part","word-cell"),s.style.backgroundColor=t.trim()?"#63BE64":"#FFF",s.style.width=`calc(${n})`,s.style.margin="3px",s.style.fontSize=`min(calc((${n})*0.568), 42px)`,s.innerHTML=t.trim(),e.appendChild(s)})),this.innerHTML="",this.append(e)}}customElements.define("word-component",v)})();